<!DOCTYPE html>
<html>
<head>
<title>Warlord: Routine at 44338</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="44283.html">44283</a>
</td>
<td class="up">Up: <a href="../maps/all.html#44338">Map</a></td>
<td class="next">
Next: <a href="44598.html">44598</a>
</td>
</tr>
</table>
<div class="description">44338: Handler: User Input</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="59807.html">GameLoop</a>.
</div>
<div class="paragraph">
Handles keyboard input, tokenises commands and validates the vocabulary.
</div>
</div>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44338"></span>
<div class="comments">
<div class="paragraph">
Reset the screen position to defaults.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">Handler_UserInput</td>
<td class="address-2"><span id="44338"></span>44338</td>
<td class="instruction">CALL <a href="42336.html">SetDefaultScreenPosition</a></td>
<td class="comment-1" rowspan="1">Call <a href="42336.html">SetDefaultScreenPosition</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44341"></span>44341</td>
<td class="instruction">CALL <a href="42567.html">PrintInputPrompt</a></td>
<td class="comment-1" rowspan="1">Call <a href="42567.html">PrintInputPrompt</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44344"></span>
<div class="comments">
<div class="paragraph">
Initialise the command buffer.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44344"></span>44344</td>
<td class="instruction">LD HL,42994</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="42994.html">CommandBuffer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44347"></span>44347</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Initialise a letter counter in <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44349"></span>44349</td>
<td class="instruction">JR <a href="44338.html#44353">UserInput_Next</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44353">UserInput_Next</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44351"></span>
<div class="comments">
<div class="paragraph">
Main input loop - process each keypress.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UserInput_Loop</td>
<td class="address-2"><span id="44351"></span>44351</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Move to the next byte of the command buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44352"></span>44352</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Increment the letter counter by one.</td>
</tr>
<tr>
<td class="asm-label">UserInput_Next</td>
<td class="address-2"><span id="44353"></span>44353</td>
<td class="instruction">CALL <a href="44239.html">Print_Cursor</a></td>
<td class="comment-1" rowspan="1">Call <a href="44239.html">Print_Cursor</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44356"></span>44356</td>
<td class="instruction">CALL <a href="42302.html">GetUserInput</a></td>
<td class="comment-1" rowspan="1">Call <a href="42302.html">GetUserInput</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44359"></span>44359</td>
<td class="instruction">CP 12</td>
<td class="comment-1" rowspan="2">Jump to <a href="44338.html#44379">ValidateUserInput</a> if "DELETE" was not pressed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44361"></span>44361</td>
<td class="instruction">JR NZ,<a href="44338.html#44379">ValidateUserInput</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44363"></span>
<div class="comments">
<div class="paragraph">
The user pressed "DELETE".
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44363"></span>44363</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="3">Jump back to <a href="44338.html#44353">UserInput_Next</a> if there hasn't been any input yet (nothing to delete).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44364"></span>44364</td>
<td class="instruction">OR B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44365"></span>44365</td>
<td class="instruction">JR Z,<a href="44338.html#44353">UserInput_Next</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44367"></span>
<div class="comments">
<div class="paragraph">
There is input which can be deleted, so action a delete!
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44367"></span>44367</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Temporarily stash the command buffer pointer in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44368"></span>
<div class="comments">
<div class="paragraph">
Print "SPACE BACKSPACE BACKSPACE SPACE BACKSPACE" to move the current print position on the screen to the previous character, and to delete the character present using a space.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44368"></span>44368</td>
<td class="instruction">LD HL,44230</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="44230.html">Messaging_SpaceBackspaceBackspaceSpaceBackspace</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44371"></span>44371</td>
<td class="instruction">CALL <a href="42373.html">PrintString</a></td>
<td class="comment-1" rowspan="1">Call <a href="42373.html">PrintString</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44374"></span>
<div class="comments">
<div class="paragraph">
Adjust the command buffer position and letter counter.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44374"></span>44374</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Restore the command buffer pointer from <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44375"></span>44375</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Decrease the command buffer pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44376"></span>44376</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="1">Decrease the letter counter by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44377"></span>44377</td>
<td class="instruction">JR <a href="44338.html#44353">UserInput_Next</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44353">UserInput_Next</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44379"></span>
<div class="comments">
<div class="paragraph">
Check which key the user pressed:
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ValidateUserInput</td>
<td class="address-2"><span id="44379"></span>44379</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="3">Jump to <a href="44338.html#44397">UserInput_WriteKeypress</a> if "ENTER" was pressed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44380"></span>44380</td>
<td class="instruction">CP 13</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44382"></span>44382</td>
<td class="instruction">JR Z,<a href="44338.html#44397">UserInput_WriteKeypress</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44384"></span>44384</td>
<td class="instruction">CP 32</td>
<td class="comment-1" rowspan="2">If the keypress was any other control key (the value being under 32 ASCII "SPACE"), it's not valid input so jump back to <a href="44338.html#44353">UserInput_Next</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44386"></span>44386</td>
<td class="instruction">JR C,<a href="44338.html#44353">UserInput_Next</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44388"></span>44388</td>
<td class="instruction">CP 128</td>
<td class="comment-1" rowspan="2">If the keypress was higher than 128 it's also not valid input so jump back to <a href="44338.html#44353">UserInput_Next</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44390"></span>44390</td>
<td class="instruction">JR NC,<a href="44338.html#44353">UserInput_Next</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44392"></span>
<div class="comments">
<div class="paragraph">
Is the command buffer full?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44392"></span>44392</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="3">Jump to <a href="44338.html#44353">UserInput_Next</a> if the letter counter is 49 (so the buffer is full).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44393"></span>44393</td>
<td class="instruction">CP 49</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44395"></span>44395</td>
<td class="instruction">JR Z,<a href="44338.html#44353">UserInput_Next</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44397"></span>
<div class="comments">
<div class="paragraph">
Writes the keypress into the command buffer and print it to the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UserInput_WriteKeypress</td>
<td class="address-2"><span id="44397"></span>44397</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="2">Write the user input key to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44398"></span>44398</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44399"></span>44399</td>
<td class="instruction">CALL <a href="44262.html">Print_UserInputToScreen</a></td>
<td class="comment-1" rowspan="1">Call <a href="44262.html">Print_UserInputToScreen</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44402"></span>
<div class="comments">
<div class="paragraph">
Did the user press "ENTER"?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44402"></span>44402</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="3">Jump to <a href="44338.html#44351">UserInput_Loop</a> if "ENTER" was not pressed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44403"></span>44403</td>
<td class="instruction">CP 13</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44405"></span>44405</td>
<td class="instruction">JR NZ,<a href="44338.html#44351">UserInput_Loop</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44407"></span>
<div class="comments">
<div class="paragraph">
The player pressed "ENTER" so begin to process the user input.
</div>
<div class="paragraph">
Clear down the user input tokens.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44407"></span>44407</td>
<td class="instruction">LD HL,43044</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="43044.html">UserInput_Token_1</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44410"></span>44410</td>
<td class="instruction">LD B,10</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">B</span> for all 10 user input tokens.</td>
</tr>
<tr>
<td class="asm-label">EmptyUserInputTokens_Loop</td>
<td class="address-2"><span id="44412"></span>44412</td>
<td class="instruction">LD (HL),255</td>
<td class="comment-1" rowspan="1">Write a termination byte (255) to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44414"></span>44414</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment <span class="register">HL</span> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44415"></span>44415</td>
<td class="instruction">DJNZ <a href="44338.html#44412">EmptyUserInputTokens_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the user input tokens counter by one and loop back to <a href="44338.html#44412">EmptyUserInputTokens_Loop</a> until all the tokens have been set to termination bytes (255).</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44417"></span>
<div class="comments">
<div class="paragraph">
Set up pointers for the command buffer, the user input tokens and the count of the number of user input tokens.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44417"></span>44417</td>
<td class="instruction">LD HL,42994</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="42994.html">CommandBuffer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44420"></span>44420</td>
<td class="instruction">LD IX,43044</td>
<td class="comment-1" rowspan="1"><span class="register">IX</span>=<a href="43044.html">UserInput_Token_1</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44424"></span>44424</td>
<td class="instruction">LD C,10</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">C</span> for the 10 user input tokens.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44426"></span>44426</td>
<td class="instruction">JR <a href="44338.html#44534">EmptyFourLetterBuffer</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44534">EmptyFourLetterBuffer</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44428"></span>
<div class="comments">
<div class="paragraph">
What's been entered isn't parsable.
</div>
<div class="paragraph">
Print "I don't understand.".
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">Response_NotUnderstood</td>
<td class="address-2"><span id="44428"></span>44428</td>
<td class="instruction">LD HL,43087</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="43087.html">Messaging_IDontUnderstand</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44431"></span>44431</td>
<td class="instruction">CALL <a href="42386.html">PrintStringAndNewline</a></td>
<td class="comment-1" rowspan="1">Call <a href="42386.html">PrintStringAndNewline</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44434"></span>44434</td>
<td class="instruction">JP <a href="44338.html#44338">Handler_UserInput</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html">Handler_UserInput</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44437"></span>
<div class="comments">
<div class="paragraph">
Process found word into user input token.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ProcessFoundWord</td>
<td class="address-2"><span id="44437"></span>44437</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="3">Stash the command buffer pointer, <span class="register">DE</span> and user input tokens counter on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44438"></span>44438</td>
<td class="instruction">PUSH DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44439"></span>44439</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44440"></span>44440</td>
<td class="instruction">LD HL,(44226)</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=*<a href="44226.html">TempStore_CommandBufferPointer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44443"></span>44443</td>
<td class="instruction">LD DE,43055</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=<a href="43055.html">FourLetterBuffer</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44446"></span>
<div class="comments">
<div class="paragraph">
Ensure that the length is not more than 4.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44446"></span>44446</td>
<td class="instruction">LD BC,4</td>
<td class="comment-1" rowspan="1"><span class="register">BC</span>=0004.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44449"></span>44449</td>
<td class="instruction">LD A,(44228)</td>
<td class="comment-1" rowspan="3">Jump to <a href="44338.html#44456">CopyWordToBuffer</a> if *<a href="44228.html">TempStore_CommandBufferCount</a> is greater than or equal to 4.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44452"></span>44452</td>
<td class="instruction">CP C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44453"></span>44453</td>
<td class="instruction">JR NC,<a href="44338.html#44456">CopyWordToBuffer</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44455"></span>
<div class="comments">
<div class="paragraph">
The length is less than 4 so no need to copy 4 bytes.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44455"></span>44455</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Copy the actual length of the word into <span class="register">C</span>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44456"></span>
<div class="comments">
<div class="paragraph">
Copy the word (up to 4 characters in length) into the four letter buffer.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CopyWordToBuffer</td>
<td class="address-2"><span id="44456"></span>44456</td>
<td class="instruction">LDIR</td>
<td class="comment-1" rowspan="1">Copy the "up-to-4" letters from the command buffer into the four-letter buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44458"></span>44458</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="3">Restore the user input token counter, <span class="register">DE</span> and command buffer pointer from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44459"></span>44459</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44460"></span>44460</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44461"></span>44461</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Stash the command buffer pointer back on the stack.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44462"></span>
<div class="comments">
<div class="paragraph">
Stash the vocabulary pointer for a separate check...
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44462"></span>44462</td>
<td class="instruction">LD HL,(42950)</td>
<td class="comment-1" rowspan="2">Stash *<a href="42950.html">Pointer_Vocabulary</a> on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44465"></span>44465</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44466"></span>
<div class="comments">
<div class="paragraph">
Ignore any usage of "THE" - this is a very good idea! If the player enters: "EXAMINE THE SKULL", this ensures it's evaluated in the exact same way as "EXAMINE SKULL" (or really, "EXAM SKUL").
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44466"></span>44466</td>
<td class="instruction">LD HL,42599</td>
<td class="comment-1" rowspan="2">Write <a href="42599.html">Table_Vocabulary_The</a> to *<a href="42950.html">Pointer_Vocabulary</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44469"></span>44469</td>
<td class="instruction">LD (42950),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44472"></span>44472</td>
<td class="instruction">CALL <a href="44283.html">44283</a></td>
<td class="comment-1" rowspan="1">Call <a href="44283.html">44283</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44475"></span>
<div class="comments">
<div class="paragraph">
Do nothing with with this match - just restore the vocabulary pointer from the stack.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44475"></span>44475</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="2">Restore *<a href="42950.html">Pointer_Vocabulary</a> from the stack and write it back to *<a href="42950.html">Pointer_Vocabulary</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44476"></span>44476</td>
<td class="instruction">LD (42950),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44479"></span>44479</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44480"></span>44480</td>
<td class="instruction">JR C,<a href="44338.html#44534">EmptyFourLetterBuffer</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44534">EmptyFourLetterBuffer</a> if <span class="register">A</span> is less than <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44482"></span>44482</td>
<td class="instruction">CALL <a href="44283.html">44283</a></td>
<td class="comment-1" rowspan="1">Call <a href="44283.html">44283</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44485"></span>44485</td>
<td class="instruction">JR C,<a href="44338.html#44526">StoreTokenAndContinue</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44526">StoreTokenAndContinue</a> if <span class="register">A</span> is less than <span class="register">C</span>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44487"></span>
<div class="comments">
<div class="paragraph">
Nothing matched ... Inform the player.
</div>
<div class="paragraph">
Print "I don't know the word:-".
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44487"></span>44487</td>
<td class="instruction">LD HL,43107</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="43107.html">Messaging_IDontKnowTheWord</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44490"></span>44490</td>
<td class="instruction">CALL <a href="42386.html">PrintStringAndNewline</a></td>
<td class="comment-1" rowspan="1">Call <a href="42386.html">PrintStringAndNewline</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44493"></span>
<div class="comments">
<div class="paragraph">
Print a double quote character: "<code>&#34;</code>".
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44493"></span>44493</td>
<td class="instruction">LD A,34</td>
<td class="comment-1" rowspan="2">Call <a href="42404.html">PrintCharacter</a> to print a double quote character (ASCII 34).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44495"></span>44495</td>
<td class="instruction">CALL <a href="42404.html">PrintCharacter</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44498"></span>44498</td>
<td class="instruction">LD HL,(44228)</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=*<a href="44228.html">TempStore_CommandBufferCount</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44501"></span>44501</td>
<td class="instruction">LD DE,(44226)</td>
<td class="comment-1" rowspan="2"><span class="register">HL</span>+=*<a href="44226.html">TempStore_CommandBufferPointer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44505"></span>44505</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44506"></span>44506</td>
<td class="instruction">LD (HL),255</td>
<td class="comment-1" rowspan="1">Write 255 to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44508"></span>44508</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Exchange the <span class="register">DE</span> and <span class="register">HL</span> registers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44509"></span>44509</td>
<td class="instruction">CALL <a href="42373.html">PrintString</a></td>
<td class="comment-1" rowspan="1">Call <a href="42373.html">PrintString</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44512"></span>
<div class="comments">
<div class="paragraph">
Print a double quote character: "<code>&#34;</code>".
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44512"></span>44512</td>
<td class="instruction">LD A,34</td>
<td class="comment-1" rowspan="2">Call <a href="42404.html">PrintCharacter</a> to print another double quote character (ASCII 34).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44514"></span>44514</td>
<td class="instruction">CALL <a href="42404.html">PrintCharacter</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44517"></span>
<div class="comments">
<div class="paragraph">
Print ".".
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44517"></span>44517</td>
<td class="instruction">LD HL,43541</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="43541.html">Messaging_FullStop</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44520"></span>44520</td>
<td class="instruction">CALL <a href="42386.html">PrintStringAndNewline</a></td>
<td class="comment-1" rowspan="1">Call <a href="42386.html">PrintStringAndNewline</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44523"></span>44523</td>
<td class="instruction">JP <a href="44338.html#44338">Handler_UserInput</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html">Handler_UserInput</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44526"></span>
<div class="comments">
<div class="paragraph">
The word in the four-letter buffer was matched!
</div>
<div class="paragraph">
Store the found token and check if we can continue parsing.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">StoreTokenAndContinue</td>
<td class="address-2"><span id="44526"></span>44526</td>
<td class="instruction">LD (IX+0),A</td>
<td class="comment-1" rowspan="1">Write the token to the current token slot.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44529"></span>44529</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Move to the next token slot.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44531"></span>44531</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Decrease the token counter by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44532"></span>44532</td>
<td class="instruction">JR Z,<a href="44338.html#44589">CheckVerbToken</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44589">CheckVerbToken</a> if all token slots are filled.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44534"></span>
<div class="comments">
<div class="paragraph">
Token matching only uses four letters of every word so a buffer is used for processing.
</div>
<div class="paragraph">
Start by clearing the buffer.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">EmptyFourLetterBuffer</td>
<td class="address-2"><span id="44534"></span>44534</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Stash the command buffer pointer and user input tokens counter on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44535"></span>44535</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44536"></span>44536</td>
<td class="instruction">LD HL,43055</td>
<td class="comment-1" rowspan="1">Load <a href="43055.html">FourLetterBuffer</a> into <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44539"></span>44539</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">B</span> for the 4 letters in the buffer.</td>
</tr>
<tr>
<td class="asm-label">EmptyFourLetterBuffer_Loop</td>
<td class="address-2"><span id="44541"></span>44541</td>
<td class="instruction">LD (HL),32</td>
<td class="comment-1" rowspan="1">Write ASCII "SPACE" (32) to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44543"></span>44543</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment <span class="register">HL</span> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44544"></span>44544</td>
<td class="instruction">DJNZ <a href="44338.html#44541">EmptyFourLetterBuffer_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the letter buffer counter by one and loop back to <a href="44338.html#44541">EmptyFourLetterBuffer_Loop</a> until all four letters have been cleared.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44546"></span>44546</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="2">Restore the user input tokens counter and command buffer pointer from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44547"></span>44547</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44548"></span>44548</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Stash <span class="register">DE</span> on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44549"></span>44549</td>
<td class="instruction">JR <a href="44338.html#44552">FindWordStart</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44552">FindWordStart</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44551"></span>
<div class="comments">
<div class="paragraph">
Skip delimiter characters to find the next word.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">SkipDelimiters</td>
<td class="address-2"><span id="44551"></span>44551</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Move to the next byte of the command buffer.</td>
</tr>
<tr>
<td class="asm-label">FindWordStart</td>
<td class="address-2"><span id="44552"></span>44552</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch a character from the command buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44553"></span>44553</td>
<td class="instruction">CP 13</td>
<td class="comment-1" rowspan="2">Jump to <a href="44338.html#44585">EndWordParsing</a> if the character is "ENTER" (ASCII 13).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44555"></span>44555</td>
<td class="instruction">JR Z,<a href="44338.html#44585">EndWordParsing</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44557"></span>44557</td>
<td class="instruction">CALL <a href="44248.html">IsDelimiter</a></td>
<td class="comment-1" rowspan="1">Call <a href="44248.html">IsDelimiter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44560"></span>44560</td>
<td class="instruction">JR Z,<a href="44338.html#44551">SkipDelimiters</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44551">SkipDelimiters</a> if the character is a delimiter.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44562"></span>
<div class="comments">
<div class="paragraph">
The character is not a delimiter.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44562"></span>44562</td>
<td class="instruction">LD (44226),HL</td>
<td class="comment-1" rowspan="1">Store the starting address of this new word in *<a href="44226.html">TempStore_CommandBufferPointer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44565"></span>44565</td>
<td class="instruction">LD DE,0</td>
<td class="comment-1" rowspan="1">Initialise <span class="register">DE</span> to 0000 to count the number of letters in the word.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44568"></span>
<div class="comments">
<div class="paragraph">
Just keep looping and moving across the command buffer until we hit a delimiter or an "ENTER" character.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CountWordLength</td>
<td class="address-2"><span id="44568"></span>44568</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Move to the next byte of the command buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44569"></span>44569</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the letter counter by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44570"></span>44570</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch a character from the command buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44571"></span>44571</td>
<td class="instruction">CP 13</td>
<td class="comment-1" rowspan="2">Jump to <a href="44338.html#44580">StoreWordLength</a> if the character is "ENTER" (ASCII 13).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44573"></span>44573</td>
<td class="instruction">JR Z,<a href="44338.html#44580">StoreWordLength</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44575"></span>44575</td>
<td class="instruction">CALL <a href="44248.html">IsDelimiter</a></td>
<td class="comment-1" rowspan="1">Call <a href="44248.html">IsDelimiter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44578"></span>44578</td>
<td class="instruction">JR NZ,<a href="44338.html#44568">CountWordLength</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44568">CountWordLength</a> if the character was not a delimiter.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44580"></span>
<div class="comments">
<div class="paragraph">
This is the end of the word, so store the word length.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">StoreWordLength</td>
<td class="address-2"><span id="44580"></span>44580</td>
<td class="instruction">LD (44228),DE</td>
<td class="comment-1" rowspan="1">Write the letter counter to *<a href="44228.html">TempStore_CommandBufferCount</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44584"></span>44584</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Set the carry flag to indicate that a word was successfully found.</td>
</tr>
<tr>
<td class="asm-label">EndWordParsing</td>
<td class="address-2"><span id="44585"></span>44585</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore <span class="register">DE</span> from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44586"></span>44586</td>
<td class="instruction">JP C,<a href="44338.html#44437">ProcessFoundWord</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="44338.html#44437">ProcessFoundWord</a> if a word was found.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44589"></span>
<div class="comments">
<div class="paragraph">
Check to see if any of the user input tokens have been populated, and if not, print "I don't understand.".
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CheckVerbToken</td>
<td class="address-2"><span id="44589"></span>44589</td>
<td class="instruction">LD A,(43044)</td>
<td class="comment-1" rowspan="3">Jump to <a href="44338.html#44428">Response_NotUnderstood</a> if *<a href="43044.html">UserInput_Token_1</a> hold the terminator byte (255).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44592"></span>44592</td>
<td class="instruction">CP 255</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44594"></span>44594</td>
<td class="instruction">JP Z,<a href="44338.html#44428">Response_NotUnderstood</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="44597"></span>44597</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<div class="comments">
<div class="paragraph">
View the equivalent code in <a href="/adventure-games/jewelsofbabylon/dec/asm/49162.html">The Jewels Of Babylon</a>.
</div>
</div>
</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="44283.html">44283</a>
</td>
<td class="up">Up: <a href="../maps/all.html#44338">Map</a></td>
<td class="next">
Next: <a href="44598.html">44598</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1985 Interceptor Software UK &copy; 2025 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.6.</div>
<div class="repository">Link to <a rel="noopener nofollow" href="https://github.com/pobtastic/adventure-games/tree/main/sources/warlord/">Source code</a>.</div>
<div><a href="../../asm/AD32.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>